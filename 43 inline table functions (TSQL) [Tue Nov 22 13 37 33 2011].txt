
--  inline table functions
--  (think - parameterized view :)
--

CREATE FUNCTION tbt.getDTVActiveAccounts( )
RETURNS @dtvAccounts TABLE
(
  BLP_BILLING_POINT_ID	varchar(100),
  DIGITALTVNUMBER	varchar(100),
  SPID_NAME	varchar(100),
  SERVICE_ADDRESS	varchar(100),
  SERVICE_ADDRESS_CITY	varchar(100),
  SERVICE_ADDRESS_PROV	varchar(100),
  SERVICE_ADDRESS_POSTCD	varchar(100),
  BPID_NAME	varchar(100),
  MAILING_STREET1	varchar(100),
  MAILING_STREET2	varchar(100),
  MAILING_STREET3	varchar(100),
  MAILING_CITY	varchar(100),
  MAILING_PROV	varchar(100),
  MAILING_POSTALCODE varchar(100),
  Home_Phone varchar(100),
  Customer_ID varchar(100)
)
AS
BEGIN

insert @dtvAccounts
select * from
openquery(SUITESOLUTIONS,
'
select 
       S.BLP_BILLING_POINT_ID,
       S.SBR_NPA || S.SBR_NXX || S.SBR_PHONE_LINE_NO as digitalTVNumber,
       decode(S.SBR_COMPANY_NAME,null, S.SBR_FIRST_NAME ||'' ''||S.SBR_LAST_NAME,S.SBR_COMPANY_NAME) as spid_name,
       trim(S.SBR_HOUSE_NUMBER) || '' '' || trim(S.SBR_STREET) ||'' '' || trim(S.SBR_STREET_SUFFIX) as service_address,
       S.SBR_city as service_address_city,
       S.SBR_STATE as service_address_prov,
       S.SBR_ZIP as service_address_postcd,
       decode(CD.CNT_COMPANY_NAME,null, CD.CNT_FIRST_NAME ||'' ''||CD.CNT_LAST_NAME,CD.CNT_COMPANY_NAME) as bpid_name,
       CD.CNT_STREET1 as Mailing_Street1,
       CD.CNT_STREET2 as Mailing_Street2,
       CD.CNT_STREET3 as Mailing_Street3,
       CD.CNT_CITY    as Mailing_City,
       CD.CNT_STATE   as Mailing_Prov,
       CD.CNT_ZIP     as Mailing_PostalCode,
       CD.CNT_HOME_NPA || CD.CNT_HOME_NXX || CD.CNT_HOME_LINE_NO as Home_Phone,
       BP.CUS_Customer_ID
  
from  
 crm.subscription_point s, 
 crm.subscriber_status ss, 
 crm.status_option so, 
 crm.billing_point bp, 
 crm.customer_address ca,
 crm.contact_detail cd, 
 crm.subscribed_plan sp

where 
  SS.SBS_SUBSCRIBER_STATUS_ID = getcurrentsubstatus(S.SBR_SUBSCRIPTION_ID)
  and SS.SBS_STATUS = SO.SOP_STATUS_ID
  and SO.SOP_STATUS_TYPE = ''A''
  and SP.SSP_SUBSCRIBED_PLAN_ID = getcurrentsubplan(s.sbr_subscription_id)
  and SP.SBR_SUBSCRIPTION_ID = s.sbr_subscription_id
  and S.BLP_BILLING_POINT_ID = BP.BLP_BILLING_POINT_ID
  and BP.BLP_BILLING_POINT_ID = CA.BLP_BILLING_POINT_ID
  and CA.CNT_CONTACT_DETAIL_ID = CD.CNT_CONTACT_DETAIL_ID
  and SUBSTR (
              GET_CSA_ADDRESS_FLAGS_FN (ca.CSA_CUSTOMER_ADDRESS_ID,
                                        TRUNC (SYSDATE, ''DD'')),
              2,
              1) = ''Y''
  and s.SBR_NXX = 450
    ')


   RETURN
END